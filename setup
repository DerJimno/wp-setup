#!/usr/bin/env bash
set -e

read -p "Enter your domain name: " DOMAIN
read -p "Enter your E-mail: " EMAIL
read -s -p "Enter the desired db password: " DBPASS
echo

sudo mariadb <<EOF
CREATE DATABASE wordpress;
CREATE USER 'wpuser'@'localhost' IDENTIFIED BY '$DBPASS';
GRANT ALL PRIVILEGES ON wordpress.* TO 'wpuser'@'localhost';
FLUSH PRIVILEGES;
EOF

# WordPress setup
sudo mkdir -p /srv/http/wordpress
cd /srv/http/wordpress
wget -q https://wordpress.org/latest.zip
unzip -q latest.zip
sudo chown -R http:http /srv/http/wordpress
sudo chmod -R 755 /srv/http/wordpress

# Nginx config
sudo mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled
cat > /etc/nginx/sites-available/wordpress <<EOL
server {
    listen 80;
    server_name $DOMAIN;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name $DOMAIN;
    root /srv/http/wordpress/wordpress;
    index index.php index.html;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include fastcgi.conf;
        fastcgi_pass unix:/run/php-fpm/php-fpm.sock;
    }
}
EOL

ln -sf /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx

# SSL with Certbot
sudo certbot --nginx -d $DOMAIN -m $EMAIL --non-interactive --agree-tos

echo "âœ… WordPress installed. Visit: https://$DOMAIN"
